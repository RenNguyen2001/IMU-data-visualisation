/* autogenerated by Processing revision 1286 on 2023-11-15 */
import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;

import processing.opengl.*;
import processing.serial.*;

import java.util.HashMap;
import java.util.ArrayList;
import java.io.File;
import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.IOException;

public class drawIMUhand extends PApplet {

//creating a simple program to represent one joint



Serial port;
String serialData;
String[][] serialStrings = new String[5][3];  //5 fingers, 3 values (the joint angles)

float grid = 400;
int spinAngGlobal = 0, yawAngGlobal;

int WHITE = 0xFFFFFFFF;
int RED = 0xFFFF0000;
int BLUE = 0xFF0000FF;
int GREEN = 0xFF00FF00;
int YELLOW = 0xFFFFFF00;

class imuData{
    float[] jointAngle = new float[4];
    float yawAngle;
    float palmAngle;
}

imuData[] imuGlobalObj = new imuData[5];


 public void setup(){
    for(char i = 0; i < 5; i++)
    {
        imuGlobalObj[i] = new imuData();
    }
    
    //size(900,900);  //setup2D
    /* size commented out by preprocessor */;   //setup3D
    serialSetup();

    frameRate(60);
    
}


 public void serialSetup(){
    for(char j = 0; j < 5; j++)
    {
    for(char i = 0; i < 3; i++)
        {
        serialStrings[j][i] = "h";  //initialising the values so it doesn't become Null
        }
    }   
  
    port = new Serial(this, "COM10", 120000);  port.bufferUntil('\n');
}

 public void draw(){
    getSerialData();
    
    background(0);

    translate((width/2),(height/2),-100);
    rotateX(radians(imuGlobalObj[0].palmAngle));
    rotateY(radians(spinAngGlobal));

    push();
        push();
        translate(0,0,0);  
        draw3Dthumb(imuGlobalObj[0],45, BLUE);
        pop();

        push();
        translate(0,0,50);  
        draw3DExample(imuGlobalObj[1],0, WHITE); println(imuGlobalObj[1].yawAngle);
        pop();

        push();
        translate(0,0,100);  
        draw3DExample(imuGlobalObj[2],0, RED);
        pop();

        push();
        translate(0,0,150);  
        draw3DExample(imuGlobalObj[3],0, GREEN);
        pop();

        push();
        translate(0,0,200);  
        draw3DExample(imuGlobalObj[4],0, YELLOW);
        pop();
    pop();
    
}


 public void draw3Dthumb(imuData imuDataObj, float yawAng, int colour){
    float x = 0, y = 0, z = 0; 
    char fingerLen = 100, fingerWid = 10;
    float[] xCenter = new float[4];
    float[] yCenter = new float[4];
    float[][] jointCoord = new float[4][2];
    float[] angleSum = new float[3];

    //jointAng[0] = 45;   jointAng[1] = 45;   jointAng[2] = 45;
    angleSum[0] = radians(imuDataObj.jointAngle[1]);
    angleSum[1] = radians(imuDataObj.jointAngle[1]+ imuDataObj.jointAngle[0]);
    //angleSum[2] = radians(imuDataObj.jointAngle[1] + imuDataObj.jointAngle[0]);

    //drawing the skeleton
    push();
        /*
        //first line
        push();
        stroke(colour);
        line(x, y, 0, x + fingerLen, y, 0);
        translate(x,y);
        sphere(5);
        pop();

        */

        //first center calculation
        xCenter[0] = x + (fingerLen/2);
        yCenter[0] = y;
        

        translate(xCenter[0],yCenter[0],z); 
        rotateY(radians(yawAng));

        //first line center
        push();
        translate(xCenter[0], yCenter[0], 0);
        stroke(colour);
        noFill();
        box(fingerLen,10,fingerWid);
        sphere(5);
        pop();

        // first-second line joint - MCP/knuckles
        push();
        jointCoord[0][0] = x + fingerLen;
        jointCoord[0][1] = y;
        translate(jointCoord[0][0], jointCoord[0][1]);
        stroke(colour);
        sphere(15); 
        pop();

        
        push();
        jointCoord[1][0] = jointCoord[0][0] + (fingerLen)*cos(angleSum[0]);
        jointCoord[1][1] = jointCoord[0][1] + (fingerLen)*sin(angleSum[0]);
        translate(jointCoord[1][0], jointCoord[1][1]);
        stroke(colour);
        sphere(5);
        pop();

        
        for(char i = 1; i < 3; i++)
        {
            //line center
            push();
            xCenter[i] = jointCoord[i-1][0] + (fingerLen/2)*cos(angleSum[i-1]); 
            yCenter[i] = jointCoord[i-1][1] + (fingerLen/2)*sin(angleSum[i-1]); 
            translate(xCenter[i], yCenter[i]);
    
            rotateZ(angleSum[i-1]);
            stroke(colour);
            noFill();
            box(fingerLen,10,fingerWid);
            sphere(5);
            pop();

            //end of line
            push();
            jointCoord[i][0] = jointCoord[i-1][0] + (fingerLen)*cos(angleSum[i-1]);
            jointCoord[i][1] = jointCoord[i-1][1] + (fingerLen)*sin(angleSum[i-1]);
            translate(jointCoord[i][0], jointCoord[i][1]);
            stroke(colour);
            sphere(5);
            pop();

            //drawing the line
            push();
            stroke(colour);
            line(jointCoord[i-1][0], jointCoord[i-1][1], 0, jointCoord[i][0], jointCoord[i][1], 0);
            pop();

        }

        
    pop();

}

 public void draw3DExample(imuData imuDataObj, float yawAng, int colour){
    float x = 0, y = 0, z = 0; 
    char fingerLen = 100, fingerWid = 10;
    float[] xCenter = new float[4];
    float[] yCenter = new float[4];
    float[][] jointCoord = new float[4][2];
    float[] angleSum = new float[3];

    //jointAng[0] = 45;   jointAng[1] = 45;   jointAng[2] = 45;
    angleSum[0] = radians(imuDataObj.jointAngle[2]);
    angleSum[1] = radians(imuDataObj.jointAngle[2] + imuDataObj.jointAngle[1]);
    angleSum[2] = radians(imuDataObj.jointAngle[2] + imuDataObj.jointAngle[1] + imuDataObj.jointAngle[0]);

    //drawing the skeleton
    push();
        

        /*
        //first line
        push();
        stroke(colour);
        line(x, y, 0, x + fingerLen, y, 0);
        translate(x,y);
        sphere(5);
        pop();

        */

        //first center calculation
        xCenter[0] = x + (fingerLen/2);
        yCenter[0] = y;
        

        translate(xCenter[0],yCenter[0],z); 
        rotateY(radians(yawAng));

        //first line center
        push();
        translate(xCenter[0], yCenter[0], 0);
        stroke(colour);
        noFill();
        box(fingerLen,10,fingerWid);
        sphere(5);
        pop();

        // first-second line joint - MCP/knuckles
        push();
        jointCoord[0][0] = x + fingerLen;
        jointCoord[0][1] = y;
        translate(jointCoord[0][0], jointCoord[0][1]);
        stroke(colour);
        sphere(15); 
        pop();

        
        for(char i = 1; i < 4; i++)
        {
            //line center
            push();
            xCenter[i] = jointCoord[i-1][0] + (fingerLen/2)*cos(angleSum[i-1]); 
            yCenter[i] = jointCoord[i-1][1] + (fingerLen/2)*sin(angleSum[i-1]); 
            translate(xCenter[i], yCenter[i]);
    
            rotateZ(angleSum[i-1]);
            stroke(colour);
            noFill();
            box(fingerLen,10,fingerWid);
            sphere(5);
            pop();

            //end of line
            push();
            jointCoord[i][0] = jointCoord[i-1][0] + (fingerLen)*cos(angleSum[i-1]);
            jointCoord[i][1] = jointCoord[i-1][1] + (fingerLen)*sin(angleSum[i-1]);
            translate(jointCoord[i][0], jointCoord[i][1]);
            stroke(colour);
            sphere(5);
            pop();

            //drawing the line
            push();
            stroke(colour);
            line(jointCoord[i-1][0], jointCoord[i-1][1], 0, jointCoord[i][0], jointCoord[i][1], 0);
            pop();

        }
    pop();

}

 public void mouseMoved() {
    spinAngGlobal++;
}

 public void mouseDragged() {
    yawAngGlobal++;
}

 public void getSerialData(){
  if( port.available() > 0) // If data is available,
  { 
    serialData = port.readStringUntil('\n');         // read the entire string until the newline
    //print(serialData);
    
    String[] receiveVar = new String[6];
    int indexNo;
    //splitting the string
    receiveVar = split(serialData, " ");  // index 0 finger strip num, 1 jointAng1(tip), 2 jointAng2(mid), 3 jointAng3(base), yaw
    indexNo = PApplet.parseInt(receiveVar[0]);  //println(indexNo);

    //storing the values into an imu object
    for(char i = 0; i < 3; i++)
    {
        imuGlobalObj[indexNo].jointAngle[i] = parseFloat(receiveVar[i+1]);   //println(imuGlobalObj[indexNo].jointAngle[i]);
    }

    imuGlobalObj[indexNo].yawAngle = -parseFloat(receiveVar[4]);
    imuGlobalObj[indexNo].palmAngle = parseFloat(receiveVar[5]);    //println(imuGlobalObj[indexNo].palmAngle);
    
    
    port.clear();
  }
}

 public void rotateShape(float xAng, float yAng, float zAng){
    rotateX(radians(xAng)); rotateY(radians(yAng)); rotateZ(radians(zAng));
}


  public void settings() { size(900, 900, P3D); }

  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "drawIMUhand" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
